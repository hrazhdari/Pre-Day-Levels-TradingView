//@version=6
indicator("Prev Day H/L + Bias + US Session (Yesterday NY, 15m)", overlay=true, max_lines_count=80, max_labels_count=80)

//â”€â”€â”€â”€â”€â”€â”€â”€ Inputs â”€â”€â”€â”€â”€â”€â”€â”€
showPrevHL      = input.bool(true,  "Show Prev Day High/Low (Blue)")
showBiasLabels  = input.bool(true,  "Show Bias Labels on Blue Lines")
showUSSession   = input.bool(true,  "Show US Session Levels for YESTERDAY (NY), calc on 15m")

usSession       = input.session("0930-1600", "US Session (NY time)")
usTZ            = input.string("America/New_York", "US Session Timezone")

blueW  = input.int(2, "Blue width",  minval=1, maxval=5)
greenW = input.int(2, "Green width", minval=1, maxval=5)
pinkW  = input.int(1, "Pink width",  minval=1, maxval=5)

blueColor  = input.color(color.new(color.blue, 0), "Blue (Prev H/L)")
greenColor = input.color(color.new(color.green, 0), "Green (US Sess H/L)")
pinkColor  = input.color(color.new(color.fuchsia, 75), "Pink (US Sess O/C)")

labelBg   = input.color(color.new(color.black, 0), "Label background")
labelText = input.color(color.white, "Label text")

// â”€â”€â”€â”€â”€ EMA Inputs (15m) â”€â”€â”€â”€â”€
showEMAs   = input.bool(true, "Show EMAs (20/50/200) from 15m")
ema20Len   = input.int(20, "EMA 20 Length", minval=1)
ema50Len   = input.int(50, "EMA 50 Length", minval=1)
ema200Len  = input.int(200,"EMA 200 Length",minval=1)

// â”€â”€â”€â”€â”€ Scenario/Bias control â”€â”€â”€â”€â”€
useBiasInScenario = input.bool(true, "Use Bias filter in Scenario (EMA + Bias must align)")

// â”€â”€â”€â”€â”€ Fixed Corner Panel (Signal HUD) â”€â”€â”€â”€â”€
showCornerPanel = input.bool(true, "Show Fixed Corner Panel (Signal HUD)")
panelCorner = input.string("TOP_RIGHT", "Panel Corner", options=["TOP_LEFT","TOP_RIGHT","BOTTOM_LEFT","BOTTOM_RIGHT"])

// Ø§ÛŒÙ† Ù…Ù‚Ø¯Ø§Ø± Ù‡Ø±Ú†ÛŒ Ø¨ÛŒØ´ØªØ± Ø¨Ø§Ø´Ù‡ Ù¾Ù†Ù„ Ø¨ÛŒØ´ØªØ± Ø¨Ù‡ Ú†Ù¾ Ù‡Ù„ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒØ´Ù‡ (Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø²ÛŒØ± Ø¢ÛŒÚ©ÙˆÙ†â€ŒÙ‡Ø§ Ù†Ø±Ù‡)
panelPadSpaces = input.int(18, "Panel Left Padding (spaces)", minval=0, maxval=60)

panelText   = input.color(color.white, "Panel Text")

// â”€â”€â”€â”€â”€ Divergence Inputs (INFO ONLY) â”€â”€â”€â”€â”€
divTF      = input.string("15", "Divergence TF", options=["", "15", "5", "60", "D"])
rsiLen     = input.int(14, "RSI Length", minval=2)
macdFast   = input.int(12, "MACD Fast", minval=1)
macdSlow   = input.int(26, "MACD Slow", minval=1)
macdSig    = input.int(9,  "MACD Signal", minval=1)
pL         = input.int(5, "Pivot Left", minval=1)
pR         = input.int(5, "Pivot Right", minval=1)

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// DAILY truth for Prev Day levels & Bias
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
pdh = request.security(syminfo.tickerid, "D", high[1],  barmerge.gaps_off, barmerge.lookahead_off)
pdl = request.security(syminfo.tickerid, "D", low[1],   barmerge.gaps_off, barmerge.lookahead_off)
c1  = request.security(syminfo.tickerid, "D", close[1], barmerge.gaps_off, barmerge.lookahead_off)

h2  = request.security(syminfo.tickerid, "D", high[2],  barmerge.gaps_off, barmerge.lookahead_off)
l2  = request.security(syminfo.tickerid, "D", low[2],   barmerge.gaps_off, barmerge.lookahead_off)

biasLong  = c1 > h2
biasShort = c1 < l2
biasInside= not biasLong and not biasShort

bias = biasLong ? "Bias: LONG" : biasShort ? "Bias: SHORT" : "Bias: INSIDE"

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// EMA 20/50/200 from 15m (shown on all TFs)
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ema20_15  = request.security(syminfo.tickerid, "15", ta.ema(close, ema20Len),  barmerge.gaps_off, barmerge.lookahead_off)
ema50_15  = request.security(syminfo.tickerid, "15", ta.ema(close, ema50Len),  barmerge.gaps_off, barmerge.lookahead_off)
ema200_15 = request.security(syminfo.tickerid, "15", ta.ema(close, ema200Len), barmerge.gaps_off, barmerge.lookahead_off)

plot(showEMAs ? ema20_15  : na, title="EMA 20 (15m)",  linewidth=1)
plot(showEMAs ? ema50_15  : na, title="EMA 50 (15m)",  linewidth=1)
plot(showEMAs ? ema200_15 : na, title="EMA 200 (15m)", linewidth=1)

// Scenario base
emaLong  = close > ema200_15 and ema20_15 > ema50_15
emaShort = close < ema200_15 and ema20_15 < ema50_15

finalLong  = useBiasInScenario ? (emaLong  and biasLong)  : emaLong
finalShort = useBiasInScenario ? (emaShort and biasShort) : emaShort

scenario =
     finalLong  ? "Scenario: LONG" :
     finalShort ? "Scenario: SHORT" :
                  "Scenario: NEUTRAL"

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Blue lines: Prev Day High/Low (D[1])
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
var line linePDH = na
var line linePDL = na

if showPrevHL
    if na(linePDH)
        linePDH := line.new(bar_index, pdh, bar_index+1, pdh, extend=extend.right, color=blueColor, width=blueW)
    else
        line.set_y1(linePDH, pdh), line.set_y2(linePDH, pdh)

    if na(linePDL)
        linePDL := line.new(bar_index, pdl, bar_index+1, pdl, extend=extend.right, color=blueColor, width=blueW)
    else
        line.set_y1(linePDL, pdl), line.set_y2(linePDL, pdl)
else
    if not na(linePDH)
        line.delete(linePDH), linePDH := na
    if not na(linePDL)
        line.delete(linePDL), linePDL := na

// Bias labels on blue lines
var label labPDH = na
var label labPDL = na

if barstate.islast
    if showPrevHL and showBiasLabels
        txtH = "PDH: " + str.tostring(pdh, format.mintick) + " | " + bias
        txtL = "PDL: " + str.tostring(pdl, format.mintick) + " | " + bias

        if na(labPDH)
            labPDH := label.new(bar_index, pdh, txtH, xloc=xloc.bar_index, yloc=yloc.price, style=label.style_label_left, color=labelBg, textcolor=labelText, size=size.small)
        else
            label.set_x(labPDH, bar_index), label.set_y(labPDH, pdh), label.set_text(labPDH, txtH)

        if na(labPDL)
            labPDL := label.new(bar_index, pdl, txtL, xloc=xloc.bar_index, yloc=yloc.price, style=label.style_label_left, color=labelBg, textcolor=labelText, size=size.small)
        else
            label.set_x(labPDL, bar_index), label.set_y(labPDL, pdl), label.set_text(labPDL, txtL)
    else
        if not na(labPDH)
            label.delete(labPDH), labPDH := na
        if not na(labPDL)
            label.delete(labPDL), labPDL := na

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// US Session (YESTERDAY NY) computed on 15m
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
sessTF = "15"

f_date_id(_t) =>
    int y = year(_t, usTZ)
    int m = month(_t, usTZ)
    int d = dayofmonth(_t, usTZ)
    y*10000 + m*100 + d

nyMidnightToday = timestamp(usTZ, year(time, usTZ), month(time, usTZ), dayofmonth(time, usTZ), 0, 0)
nyMidnightYest  = nyMidnightToday - 24*60*60*1000
targetNYDateId  = f_date_id(nyMidnightYest)

f_build_session() =>
    bool inSess = not na(time(timeframe.period, usSession, usTZ))
    bool sStart = inSess and not inSess[1]
    bool sEnd   = not inSess and inSess[1]

    var float o = na
    var float h = na
    var float l = na
    var float c = na
    var int   did = na

    float outO = na
    float outH = na
    float outL = na
    float outC = na
    int   outD = na

    if sStart
        o := open
        h := high
        l := low
        c := close
        did := f_date_id(time)

    if inSess
        h := na(h) ? high : math.max(h, high)
        l := na(l) ? low  : math.min(l, low)
        c := close

    if sEnd
        outO := o
        outH := h
        outL := l
        outC := c
        outD := did
        o := na, h := na, l := na, c := na, did := na

    [outO, outH, outL, outC, outD]

[sO, sH, sL, sC, sD] = request.security(syminfo.tickerid, sessTF, f_build_session(), barmerge.gaps_off, barmerge.lookahead_off)

// store last 6 completed sessions
var float sessO1=na
var float sessH1=na
var float sessL1=na
var float sessC1=na
var int   sessD1=na
var float sessO2=na
var float sessH2=na
var float sessL2=na
var float sessC2=na
var int   sessD2=na
var float sessO3=na
var float sessH3=na
var float sessL3=na
var float sessC3=na
var int   sessD3=na
var float sessO4=na
var float sessH4=na
var float sessL4=na
var float sessC4=na
var int   sessD4=na
var float sessO5=na
var float sessH5=na
var float sessL5=na
var float sessC5=na
var int   sessD5=na
var float sessO6=na
var float sessH6=na
var float sessL6=na
var float sessC6=na
var int   sessD6=na

if not na(sD)
    sessO6:=sessO5, sessH6:=sessH5, sessL6:=sessL5, sessC6:=sessC5, sessD6:=sessD5
    sessO5:=sessO4, sessH5:=sessH4, sessL5:=sessL4, sessC5:=sessC4, sessD5:=sessD4
    sessO4:=sessO3, sessH4:=sessH3, sessL4:=sessL3, sessC4:=sessC3, sessD4:=sessD3
    sessO3:=sessO2, sessH3:=sessH2, sessL3:=sessL2, sessC3:=sessC2, sessD3:=sessD2
    sessO2:=sessO1, sessH2:=sessH1, sessL2:=sessL1, sessC2:=sessC1, sessD2:=sessD1
    sessO1:=sO,     sessH1:=sH,     sessL1:=sL,     sessC1:=sC,     sessD1:=sD

float usO = na
float usH = na
float usL = na
float usC = na
bool  matched = false

if sessD1 == targetNYDateId
    usO:=sessO1, usH:=sessH1, usL:=sessL1, usC:=sessC1, matched:=true
else if sessD2 == targetNYDateId
    usO:=sessO2, usH:=sessH2, usL:=sessL2, usC:=sessC2, matched:=true
else if sessD3 == targetNYDateId
    usO:=sessO3, usH:=sessH3, usL:=sessL3, usC:=sessC3, matched:=true
else if sessD4 == targetNYDateId
    usO:=sessO4, usH:=sessH4, usL:=sessL4, usC:=sessC4, matched:=true
else if sessD5 == targetNYDateId
    usO:=sessO5, usH:=sessH5, usL:=sessL5, usC:=sessC5, matched:=true
else if sessD6 == targetNYDateId
    usO:=sessO6, usH:=sessH6, usL:=sessL6, usC:=sessC6, matched:=true

var line lineUSH = na
var line lineUSL = na
var line lineUSO = na
var line lineUSC = na

if showUSSession and matched
    if na(lineUSH)
        lineUSH := line.new(bar_index, usH, bar_index+1, usH, extend=extend.right, color=greenColor, width=greenW)
    else
        line.set_y1(lineUSH, usH), line.set_y2(lineUSH, usH)

    if na(lineUSL)
        lineUSL := line.new(bar_index, usL, bar_index+1, usL, extend=extend.right, color=greenColor, width=greenW)
    else
        line.set_y1(lineUSL, usL), line.set_y2(lineUSL, usL)

    if na(lineUSO)
        lineUSO := line.new(bar_index, usO, bar_index+1, usO, extend=extend.right, color=pinkColor, width=pinkW)
    else
        line.set_y1(lineUSO, usO), line.set_y2(lineUSO, usO)

    if na(lineUSC)
        lineUSC := line.new(bar_index, usC, bar_index+1, usC, extend=extend.right, color=pinkColor, width=pinkW)
    else
        line.set_y1(lineUSC, usC), line.set_y2(lineUSC, usC)

if not showUSSession
    if not na(lineUSH)
        line.delete(lineUSH), lineUSH := na
    if not na(lineUSL)
        line.delete(lineUSL), lineUSL := na
    if not na(lineUSO)
        line.delete(lineUSO), lineUSO := na
    if not na(lineUSC)
        line.delete(lineUSC), lineUSC := na

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// FIXED CORNER PANEL: Signal + Zone + Score + ÙˆØ§Ú¯Ø±Ø§ÛŒÛŒ RSI/MACD
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
f_pos(_c) =>
    switch _c
        "TOP_LEFT"     => position.top_left
        "TOP_RIGHT"    => position.top_right
        "BOTTOM_LEFT"  => position.bottom_left
        => position.bottom_right

useTf = divTF == "" ? timeframe.period : divTF

f_div_signals() =>
    r = ta.rsi(close, rsiLen)
    [macdLine, signalLine, hist] = ta.macd(close, macdFast, macdSlow, macdSig)

    pl_price = ta.pivotlow(low,  pL, pR)
    ph_price = ta.pivothigh(high, pL, pR)

    pl_rsi = ta.pivotlow(r,  pL, pR)
    ph_rsi = ta.pivothigh(r, pL, pR)

    pl_macd = ta.pivotlow(hist,  pL, pR)
    ph_macd = ta.pivothigh(hist, pL, pR)

    var float prevPL_price = na
    var float lastPL_price = na
    var float prevPH_price = na
    var float lastPH_price = na

    var float prevPL_rsi = na
    var float lastPL_rsi = na
    var float prevPH_rsi = na
    var float lastPH_rsi = na

    var float prevPL_macd = na
    var float lastPL_macd = na
    var float prevPH_macd = na
    var float lastPH_macd = na

    bool rsiBull = false, rsiBear = false
    bool macdBull = false, macdBear = false

    if not na(pl_price) and not na(pl_rsi)
        prevPL_price := lastPL_price
        lastPL_price := pl_price
        prevPL_rsi   := lastPL_rsi
        lastPL_rsi   := pl_rsi
        rsiBull := not na(prevPL_price) and lastPL_price < prevPL_price and lastPL_rsi > prevPL_rsi

    if not na(ph_price) and not na(ph_rsi)
        prevPH_price := lastPH_price
        lastPH_price := ph_price
        prevPH_rsi   := lastPH_rsi
        lastPH_rsi   := ph_rsi
        rsiBear := not na(prevPH_price) and lastPH_price > prevPH_price and lastPH_rsi < prevPH_rsi

    if not na(pl_price) and not na(pl_macd)
        prevPL_price := lastPL_price
        lastPL_price := pl_price
        prevPL_macd  := lastPL_macd
        lastPL_macd  := pl_macd
        macdBull := not na(prevPL_price) and lastPL_price < prevPL_price and lastPL_macd > prevPL_macd

    if not na(ph_price) and not na(ph_macd)
        prevPH_price := lastPH_price
        lastPH_price := ph_price
        prevPH_macd  := lastPH_macd
        lastPH_macd  := ph_macd
        macdBear := not na(prevPH_price) and lastPH_price > prevPH_price and lastPH_macd < prevPH_macd

    [rsiBull, rsiBear, macdBull, macdBear]

[rsiBullSig, rsiBearSig, macdBullSig, macdBearSig] =  request.security(syminfo.tickerid, useTf, f_div_signals(), barmerge.gaps_off, barmerge.lookahead_off)
// â”€â”€â”€â”€â”€ Divergence strength (Weak / Strong) â”€â”€â”€â”€â”€
rsiSeries  = request.security(syminfo.tickerid, useTf, ta.rsi(close, rsiLen), barmerge.gaps_off, barmerge.lookahead_off)

f_macd_hist() =>
    [m, s, h] = ta.macd(close, macdFast, macdSlow, macdSig)
    h

macdHist_sec = request.security(
     syminfo.tickerid,
     useTf,
     f_macd_hist(),
     barmerge.gaps_off,
     barmerge.lookahead_off
)

// Ø³Ø§Ø¯Ù‡ Ùˆ Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒ:
// ØµØ¹ÙˆØ¯ÛŒ Ù‚ÙˆÛŒ ÙˆÙ‚ØªÛŒ RSI Ø¯Ø± Ù†Ø§Ø­ÛŒÙ‡ Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ± (Ø²ÛŒØ± 40) Ø¨ÙˆØ¯Ù‡
// Ù†Ø²ÙˆÙ„ÛŒ Ù‚ÙˆÛŒ ÙˆÙ‚ØªÛŒ RSI Ø¯Ø± Ù†Ø§Ø­ÛŒÙ‡ Ø¨Ø§Ù„Ø§ØªØ± (Ø¨Ø§Ù„Ø§ÛŒ 60) Ø¨ÙˆØ¯Ù‡
rsiLowWin  = ta.lowest(rsiSeries, pL + pR)
rsiHighWin = ta.highest(rsiSeries, pL + pR)

rsiBullStrong = rsiBullSig and rsiLowWin < 40
rsiBearStrong = rsiBearSig and rsiHighWin > 60


// Ø¨Ø±Ø§ÛŒ MACD ÙØ¹Ù„Ø§Ù‹ Strong = Ù‡Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ ÙˆØ§Ú¯Ø±Ø§ÛŒÛŒ
macdBullStrong = macdBullSig
macdBearStrong = macdBearSig


// // ÙˆØ§Ú¯Ø±Ø§ÛŒÛŒ: ÙÙ‚Ø· â€œØ¯Ø§Ø±Ø¯/Ù†Ø¯Ø§Ø±Ø¯â€ + Ø¬Ù‡Øª (ØµØ¹ÙˆØ¯ÛŒ/Ù†Ø²ÙˆÙ„ÛŒ)
// var string rsiDivText  = "ÙˆØ§Ú¯Ø±Ø§ÛŒÛŒ RSI: Ù†Ø¯Ø§Ø±Ø¯"
// var string macdDivText = "ÙˆØ§Ú¯Ø±Ø§ÛŒÛŒ MACD: Ù†Ø¯Ø§Ø±Ø¯"

// if rsiBullSig
//     rsiDivText := "ÙˆØ§Ú¯Ø±Ø§ÛŒÛŒ RSI: Ø¯Ø§Ø±Ø¯ (ØµØ¹ÙˆØ¯ÛŒ)"
// else if rsiBearSig
//     rsiDivText := "ÙˆØ§Ú¯Ø±Ø§ÛŒÛŒ RSI: Ø¯Ø§Ø±Ø¯ (Ù†Ø²ÙˆÙ„ÛŒ)"

// if macdBullSig
//     macdDivText := "ÙˆØ§Ú¯Ø±Ø§ÛŒÛŒ MACD: Ø¯Ø§Ø±Ø¯ (ØµØ¹ÙˆØ¯ÛŒ)"
// else if macdBearSig
//     macdDivText := "ÙˆØ§Ú¯Ø±Ø§ÛŒÛŒ MACD: Ø¯Ø§Ø±Ø¯ (Ù†Ø²ÙˆÙ„ÛŒ)"

// rsiDiv  = rsiBullSig or rsiBearSig
// macdDiv = macdBullSig or macdBearSig
// ÙˆØ§Ú¯Ø±Ø§ÛŒÛŒ: ÙÙ‚Ø· â€œØ¯Ø§Ø±Ø¯/Ù†Ø¯Ø§Ø±Ø¯â€ + Ø¬Ù‡Øª (ØµØ¹ÙˆØ¯ÛŒ/Ù†Ø²ÙˆÙ„ÛŒ) â€” Ø¨Ø§ ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§ (ØªØ§ Ù‚Ø¯ÛŒÙ…ÛŒ Ù†Ù…Ø§Ù†Ø¯)
divLookbackBars = 80

var int rsiLastDivBar  = na
var int macdLastDivBar = na
var string rsiLastDir  = ""
var string macdLastDir = ""
var string rsiLastStrength  = ""
var string macdLastStrength = ""

if rsiBullSig
    rsiLastDivBar := bar_index
    rsiLastDir := "ØµØ¹ÙˆØ¯ÛŒ"
    rsiLastStrength := rsiBullStrong ? "Ù‚ÙˆÛŒ" : "Ø¶Ø¹ÛŒÙ"
else if rsiBearSig
    rsiLastDivBar := bar_index
    rsiLastDir := "Ù†Ø²ÙˆÙ„ÛŒ"
    rsiLastStrength := rsiBearStrong ? "Ù‚ÙˆÛŒ" : "Ø¶Ø¹ÛŒÙ"


if macdBullSig
    macdLastDivBar := bar_index
    macdLastDir := "ØµØ¹ÙˆØ¯ÛŒ"
    macdLastStrength := macdBullStrong ? "Ù‚ÙˆÛŒ" : "Ø¶Ø¹ÛŒÙ"
else if macdBearSig
    macdLastDivBar := bar_index
    macdLastDir := "Ù†Ø²ÙˆÙ„ÛŒ"
    macdLastStrength := macdBearStrong ? "Ù‚ÙˆÛŒ" : "Ø¶Ø¹ÛŒÙ"


rsiHasRecent  = not na(rsiLastDivBar)  and (bar_index - rsiLastDivBar)  <= divLookbackBars
macdHasRecent = not na(macdLastDivBar) and (bar_index - macdLastDivBar) <= divLookbackBars

rsiDivText  = rsiHasRecent  ? ("ÙˆØ§Ú¯Ø±Ø§ÛŒÛŒ RSI: Ø¯Ø§Ø±Ø¯ ("  + rsiLastDir  + " - " + rsiLastStrength  + ")") : "ÙˆØ§Ú¯Ø±Ø§ÛŒÛŒ RSI: Ù†Ø¯Ø§Ø±Ø¯"
macdDivText = macdHasRecent ? ("ÙˆØ§Ú¯Ø±Ø§ÛŒÛŒ MACD: Ø¯Ø§Ø±Ø¯ (" + macdLastDir + " - " + macdLastStrength + ")") : "ÙˆØ§Ú¯Ø±Ø§ÛŒÛŒ MACD: Ù†Ø¯Ø§Ø±Ø¯"

rsiDiv  = rsiHasRecent
macdDiv = macdHasRecent

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// SIGNAL + SCORE + ZONE
// Score (0..5):
// 1) Scenario is LONG/SHORT (not neutral)
// 2) Bias is LONG/SHORT (not inside)
// 3) Scenario aligns with Bias (if bias filter is ON) OR at least scenario exists (if OFF)
// 4) RSI divergence exists
// 5) MACD divergence exists
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
scenarioOk = finalLong or finalShort
biasOk     = biasLong or biasShort
alignOk    = useBiasInScenario ? ((finalLong and biasLong) or (finalShort and biasShort)) : scenarioOk

score = 0
score += scenarioOk ? 1 : 0
score += biasOk ? 1 : 0
score += alignOk ? 1 : 0
score += rsiDiv ? 1 : 0
score += macdDiv ? 1 : 0

signal =
     finalLong  ? "SIGNAL: LONG" :
     finalShort ? "SIGNAL: SHORT" :
                  "SIGNAL: WAIT"

zoneText = score >= 4 ? "ğŸ”¥ High Probability Zone" : score >= 2 ? "âš ï¸ Conflict Zone" : "â›” No Setup"

// Panel color by zone
panelBg =
     score >= 4 ? color.new(color.green, 0) :
     score >= 2 ? color.new(color.yellow, 0) :
                  color.new(color.red, 0)

// Padding to push panel left (avoid icons)
pad = str.repeat(" ", panelPadSpaces)

// One fixed table panel (2 columns: left is padding, right is content)
var table panel = na
if showCornerPanel and na(panel)
    panel := table.new(f_pos(panelCorner), 2, 1, frame_color=color.new(color.white, 80), border_color=color.new(color.white, 80))

if barstate.islast
    if showCornerPanel
        table.cell(panel, 0, 0, pad, text_color=color.new(color.white, 100), bgcolor=color.new(color.black, 100))
        txt =
             signal + "\n" +
             scenario + " | " + bias + (useBiasInScenario ? " | BiasFilter: ON" : " | BiasFilter: OFF") + "\n" +
             zoneText + " | Score: " + str.tostring(score) + "/5\n\n" +
             "Divergence (" + useTf + ")\n" +
             rsiDivText + "\n" +
             macdDivText
        table.cell(panel, 1, 0, txt, text_color=panelText, bgcolor=panelBg, text_size=size.small)
    else
        if not na(panel)
            table.delete(panel)
            panel := na
